name: Cypress Sequential Tests - Folder 1

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose the environment'
        required: true
        default: 'pentest'
        type: choice
        options:
          - pentest
          - dev
          - qa
          - secure
      api_timeout:
        description: 'Choose the API timeout'
        required: true
        default: '60000'
        type: choice
        options:
          - 60000
          - 80000
          - 90000
      org_number:
        description: 'Choose the Org'
        required: true
        type: choice
        options:
          - 1
          - 2
          - 3
          - 4

permissions: write-all

jobs:
  cypress-tests:
    name: Cypress â€“ ${{ matrix.spec_group }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - spec_group: add-case-spec
          - spec_group: add-item-spec
          - spec_group: add-media-spec
          - spec_group: add-notes-spec
          - spec_group: add-person-spec
          - spec_group: add-task-spec
          - spec_group: add-user-spec
          - spec_group: dispo-auth-spec

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests
        run: >
          npx cypress run
          --headless
          --browser chrome
          --record
          --key a6df584b-4d1e-485f-a673-2c371d167e62
          --group "org-${{ matrix.spec_group }}"
          --ci-build-id "${{ github.run_id }}-${{ matrix.spec_group }}"
          --spec "src/specs/org1/${{ matrix.spec_group }}.js"
          --env environment=${{ github.event.inputs.environment }},orgNum=${{ github.event.inputs.org_number }},apiTimeout=${{ github.event.inputs.api_timeout }},defaultCommandTimeout=${{ github.event.inputs.command_timeout }}

        env:
          CI: true

      # OPTIONAL: If you generate reports per spec
      # - name: Publish report
      #   if: always()
      #   run: npm run publish-report

  slack-notification:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: [cypress-tests]
    if: always()

    steps:
      - name: Set date
        run: echo "NOW=$(date +'%B_%d')" >> $GITHUB_ENV

      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: ${{ needs.cypress-tests.result }}
          SLACK_TITLE: Cypress Test Results
          SLACK_USERNAME: Cypress_Tests
          SLACK_MESSAGE: |
            Environment: ${{ github.event.inputs.environment }}
            Org: ${{ github.event.inputs.org_number }}

            Cypress Dashboard:
            https://cloud.cypress.io/projects/8ismn2/branches/${{ github.ref_name }}/runs

            Report URL:
            https://safe-qa.github.io/report_${{ env.NOW }}
